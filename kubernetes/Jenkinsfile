pipeline {
    agent any
    stages {
        stage('Install Checkov') {
            steps {
                // Install Checkov on the Jenkins agent
                sh 'pip install checkov --user'
            }
        }
        stage('Run Checkov Scan') {
            steps {
                script {
                    // Scan the Terraform files in the 'kubernetes' directory
                    def scanResult = sh(
                        script: '~/.local/bin/checkov -d kubernetes --quiet --compact',
                        returnStatus: true
                    )
                    
                    // Fail the pipeline if vulnerabilities are found
                    if (scanResult != 0) {
                        error("Checkov detected vulnerabilities in the Terraform scripts located in the kubernetes folder.")
                    }
                }
            }
        }
    }
    post {
        always {
            echo 'Pipeline execution completed.'
        }
        failure {
            mail to: 'yusuftaofeek55@gmail.com',
                 subject: 'Checkov Scan Failed',
                 body: 'The Jenkins pipeline failed because Checkov detected vulnerabilities in the Terraform scripts. Check the pipeline logs for more details.'
        }
    }
}
